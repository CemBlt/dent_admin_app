{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>{{ page_title }} • Randevu Yönetimi</title>
    <link rel="stylesheet" href="{% static 'panel/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'panel/appointment.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
<aside class="sidebar">
    <div>
        <div class="brand">{{ hospital.name }}</div>
        <p style="margin:4px 0 0; font-size:13px;" class="muted-text">{{ hospital.address }}</p>
    </div>
    <ul class="nav-links">
        <li><a href="{% url 'dashboard' %}"><i class="bi bi-speedometer2"></i> Genel Bakış</a></li>
        <li><a href="{% url 'hospital_settings' %}"><i class="bi bi-building"></i> Hastane Bilgileri</a></li>
        <li><a href="{% url 'doctor_management' %}"><i class="bi bi-person-badge"></i> Doktorlar</a></li>
        <li><a class="active" href="{% url 'appointment_management' %}"><i class="bi bi-calendar-check"></i> Randevular</a></li>
        <li><a href="{% url 'schedule_management' %}"><i class="bi bi-calendar3"></i> Çalışma Takvimi</a></li>
        <li><a href="{% url 'service_management' %}"><i class="bi bi-briefcase"></i> Hizmetler</a></li>
        <li><a href="{% url 'review_management' %}"><i class="bi bi-chat-left-text"></i> Yorumlar</a></li>
        <li><a href="{% url 'settings' %}"><i class="bi bi-gear"></i> Ayarlar</a></li>
    </ul>
    
    <!-- Tema Değiştirme -->
    <div class="theme-toggle">
        <button class="theme-btn" data-theme="light" title="Açık Tema">
            <i class="bi bi-sun-fill"></i>
        </button>
        <button class="theme-btn active" data-theme="dark" title="Koyu Tema">
            <i class="bi bi-moon-fill"></i>
        </button>
    </div>
</aside>
<div class="content">
    <div class="top-bar">
        <div>
            <p style="margin:0; font-size:13px;" class="muted-text">Randevu Akışı</p>
            <h1>{{ page_title }}</h1>
        </div>
    </div>

    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <section class="kpi-grid">
        <article class="kpi-card">
            <span class="pill" style="background:#FDE68A33; color:#F59E0B;">Bekleyen</span>
            <div class="value">{{ summary.pending }}</div>
            <p style="margin:0;" class="muted-text">Onay bekleyen randevular</p>
        </article>
        <article class="kpi-card">
            <span class="pill" style="background:#C6F6D533; color:#047857;">Tamamlanan</span>
            <div class="value">{{ summary.completed }}</div>
            <p style="margin:0;" class="muted-text">Son kayıtlı tamamlananlar</p>
        </article>
        <article class="kpi-card">
            <span class="pill" style="background:#FECACA33; color:#B91C1C;">İptal</span>
            <div class="value">{{ summary.cancelled }}</div>
            <p style="margin:0;" class="muted-text">İptal edilen randevular</p>
        </article>
        <article class="kpi-card">
            <span class="pill" style="background:#BFDBFE; color:#1E3A8A;">Bugün</span>
            <div class="value">{{ summary.today }}</div>
            <p style="margin:0;" class="muted-text">Bugünün toplam randevusu</p>
        </article>
    </section>

    <section class="panel-card">
        <h2>Randevuları Filtrele</h2>
        <form method="get" class="filter-grid">
            {{ filter_form.as_p }}
            <div style="align-self:flex-end;">
                <button type="submit" class="primary">Filtrele</button>
            </div>
        </form>
    </section>

    <section class="panel-card">
        <h2>Randevu Listesi</h2>
        <div class="table-wrapper">
            <table class="appointment-table">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Hasta • Hizmet</th>
                        <th>Doktor</th>
                        <th>Not</th>
                        <th>Durum</th>
                        <th>Aksiyonlar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in appointments %}
                        <tr>
                            <td>
                                <strong>{{ item.data.date }}</strong>
                                <p>{{ item.data.time }}</p>
                            </td>
                            <td>
                                <strong>{{ item.patient }}</strong>
                                <p>{{ item.service }}</p>
                            </td>
                            <td>{{ item.doctor }}</td>
                            <td>
                                <details>
                                    <summary>{{ item.data.notes|default:'Not yok' }}</summary>
                                    <form method="post">
                                        {% csrf_token %}
                                        <input type="hidden" name="form_type" value="update_note">
                                        {{ item.note_form.as_p }}
                                        <button type="submit" class="primary">Kaydet</button>
                                    </form>
                                </details>
                            </td>
                            <td>
                                <span class="status-chip status-{{ item.status_class }}">{{ item.status_label }}</span>
                                <form method="post" class="status-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="form_type" value="update_status">
                                    {{ item.status_form.as_p }}
                                    <button type="submit" class="link">Güncelle</button>
                                </form>
                            </td>
                            <td>
                                <form method="post" class="inline-form" onsubmit="return confirm('Bu randevuyu silmek istediğinize emin misiniz?');">
                                    {% csrf_token %}
                                    <input type="hidden" name="form_type" value="delete_appointment">
                                    <input type="hidden" name="appointment_id" value="{{ item.data.id }}">
                                    <button type="submit" class="danger">Sil</button>
                                </form>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="empty-state">Randevu bulunamadı.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</div>

<script>
// Tema Yönetimi
(function() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    const themeButtons = document.querySelectorAll('.theme-btn');
    themeButtons.forEach(btn => {
        if (btn.dataset.theme === savedTheme) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    themeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const theme = this.dataset.theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
})();
</script>
</body>
</html>
