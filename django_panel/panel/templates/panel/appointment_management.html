{% load static %}
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>{{ page_title }} • Randevu Yönetimi</title>
    <link rel="stylesheet" href="{% static 'panel/dashboard.css' %}">
    <link rel="stylesheet" href="{% static 'panel/appointment.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>
<body>
<aside class="sidebar">
    <div>
        <div class="brand">{{ hospital.name }}</div>
        <p style="margin:4px 0 0; font-size:13px;" class="muted-text">{{ hospital.address }}</p>
    </div>
    <ul class="nav-links">
        <li><a href="{% url 'dashboard' %}"><i class="bi bi-speedometer2"></i> Genel Bakış</a></li>
        <li><a href="{% url 'hospital_settings' %}"><i class="bi bi-building"></i> Hastane Bilgileri</a></li>
        <li><a href="{% url 'doctor_management' %}"><i class="bi bi-person-badge"></i> Doktorlar</a></li>
        <li><a class="active" href="{% url 'appointment_management' %}"><i class="bi bi-calendar-check"></i> Randevular</a></li>
        <li><a href="{% url 'schedule_management' %}"><i class="bi bi-calendar3"></i> Çalışma Takvimi</a></li>
        <li><a href="{% url 'service_management' %}"><i class="bi bi-briefcase"></i> Hizmetler</a></li>
        <li><a href="{% url 'review_management' %}"><i class="bi bi-chat-left-text"></i> Yorumlar</a></li>
        <li><a href="{% url 'settings' %}"><i class="bi bi-gear"></i> Ayarlar</a></li>
    </ul>
    
    <!-- Tema Değiştirme -->
    <div class="theme-toggle">
        <button class="theme-btn" data-theme="light" title="Açık Tema">
            <i class="bi bi-sun-fill"></i>
        </button>
        <button class="theme-btn active" data-theme="dark" title="Koyu Tema">
            <i class="bi bi-moon-fill"></i>
        </button>
    </div>
</aside>
<div class="content">
    <div class="top-bar">
        <div>
            <p style="margin:0; font-size:13px;" class="muted-text">Randevu Akışı</p>
            <h1>{{ page_title }}</h1>
        </div>
    </div>

    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="message {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <section class="kpi-grid">
        <article class="kpi-card">
            <span class="pill" style="background:#FDE68A33; color:#F59E0B;">Bekleyen</span>
            <div class="value">{{ summary.pending }}</div>
            <p style="margin:0;" class="muted-text">Onay bekleyen randevular</p>
        </article>
        <article class="kpi-card">
            <span class="pill" style="background:#C6F6D533; color:#047857;">Tamamlanan</span>
            <div class="value">{{ summary.completed }}</div>
            <p style="margin:0;" class="muted-text">Son kayıtlı tamamlananlar</p>
        </article>
        <article class="kpi-card">
            <span class="pill" style="background:#FECACA33; color:#B91C1C;">İptal</span>
            <div class="value">{{ summary.cancelled }}</div>
            <p style="margin:0;" class="muted-text">İptal edilen randevular</p>
        </article>
        <article class="kpi-card">
            <span class="pill" style="background:#BFDBFE; color:#1E3A8A;">Bugün</span>
            <div class="value">{{ summary.today }}</div>
            <p style="margin:0;" class="muted-text">Bugünün toplam randevusu</p>
        </article>
    </section>

    <section class="panel-card">
        <h2>Randevuları Filtrele</h2>
        <form method="get" class="filter-grid">
            {{ filter_form.as_p }}
            <div style="align-self:flex-end;">
                <button type="submit" class="primary">Filtrele</button>
            </div>
        </form>
    </section>

    <section class="panel-card">
        <h2>Randevu Listesi</h2>
        <div class="table-wrapper">
            <table class="appointment-table">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Hasta • Hizmet</th>
                        <th>Doktor</th>
                        <th>Not</th>
                        <th>Durum</th>
                        <th>Aksiyonlar</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in appointments %}
                        <tr>
                            <td>
                                <strong>{{ item.formatted_date }}</strong>
                                <p>{{ item.data.time }}</p>
                            </td>
                            <td>
                                <strong>{{ item.patient }}</strong>
                                <p>{{ item.service }}</p>
                            </td>
                            <td>{{ item.doctor }}</td>
                            <td>
                                {% if item.data.notes %}
                                    <div style="max-width: 200px; word-wrap: break-word; font-size: 13px; color: var(--text);">
                                        {{ item.data.notes }}
                                    </div>
                                {% else %}
                                    <span style="color: var(--text-secondary); font-size: 13px; font-style: italic;">Not yok</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="status-chip status-{{ item.status_class }}">{{ item.status_label }}</span>
                                <form method="post" class="status-form">
                                    {% csrf_token %}
                                    <input type="hidden" name="form_type" value="update_status">
                                    {{ item.status_form.as_p }}
                                    <button type="submit" class="link">Güncelle</button>
                                </form>
                            </td>
                            <td>
                                <form method="post" class="inline-form" onsubmit="return confirm('Bu randevuyu silmek istediğinize emin misiniz?');">
                                    {% csrf_token %}
                                    <input type="hidden" name="form_type" value="delete_appointment">
                                    <input type="hidden" name="appointment_id" value="{{ item.data.id }}">
                                    <button type="submit" class="danger">Sil</button>
                                </form>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="6" class="empty-state">Randevu bulunamadı.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if appointments.has_other_pages %}
            <div class="pagination-wrapper" style="margin-top: 24px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span style="color: var(--text-secondary); font-size: 14px;">
                        Toplam {{ paginator.count }} randevu
                    </span>
                    <span style="color: var(--text-secondary); font-size: 14px;">
                        (Sayfa {{ appointments.number }} / {{ paginator.num_pages }})
                    </span>
                </div>
                <div class="pagination" style="display: flex; gap: 8px; align-items: center;">
                    {% if appointments.has_previous %}
                        <a href="?page=1{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.doctor %}&doctor={{ request.GET.doctor }}{% endif %}{% if request.GET.service %}&service={{ request.GET.service }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}" 
                           class="pagination-btn" style="padding: 8px 12px; border-radius: 8px; background: var(--card); border: 1px solid var(--card-border); color: var(--text); text-decoration: none; font-size: 14px;">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                        <a href="?page={{ appointments.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.doctor %}&doctor={{ request.GET.doctor }}{% endif %}{% if request.GET.service %}&service={{ request.GET.service }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}" 
                           class="pagination-btn" style="padding: 8px 12px; border-radius: 8px; background: var(--card); border: 1px solid var(--card-border); color: var(--text); text-decoration: none; font-size: 14px;">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    {% else %}
                        <span class="pagination-btn disabled" style="padding: 8px 12px; border-radius: 8px; background: var(--bg); border: 1px solid var(--card-border); color: var(--text-secondary); font-size: 14px; cursor: not-allowed;">
                            <i class="bi bi-chevron-double-left"></i>
                        </span>
                        <span class="pagination-btn disabled" style="padding: 8px 12px; border-radius: 8px; background: var(--bg); border: 1px solid var(--card-border); color: var(--text-secondary); font-size: 14px; cursor: not-allowed;">
                            <i class="bi bi-chevron-left"></i>
                        </span>
                    {% endif %}
                    
                    {% for num in appointments.paginator.page_range %}
                        {% if appointments.number == num %}
                            <span class="pagination-btn active" style="padding: 8px 12px; border-radius: 8px; background: var(--primary); color: #fff; font-size: 14px; font-weight: 600;">
                                {{ num }}
                            </span>
                        {% elif num > appointments.number|add:'-3' and num < appointments.number|add:'3' %}
                            <a href="?page={{ num }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.doctor %}&doctor={{ request.GET.doctor }}{% endif %}{% if request.GET.service %}&service={{ request.GET.service }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}" 
                               class="pagination-btn" style="padding: 8px 12px; border-radius: 8px; background: var(--card); border: 1px solid var(--card-border); color: var(--text); text-decoration: none; font-size: 14px;">
                                {{ num }}
                            </a>
                        {% endif %}
                    {% endfor %}
                    
                    {% if appointments.has_next %}
                        <a href="?page={{ appointments.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.doctor %}&doctor={{ request.GET.doctor }}{% endif %}{% if request.GET.service %}&service={{ request.GET.service }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}" 
                           class="pagination-btn" style="padding: 8px 12px; border-radius: 8px; background: var(--card); border: 1px solid var(--card-border); color: var(--text); text-decoration: none; font-size: 14px;">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                        <a href="?page={{ paginator.num_pages }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.doctor %}&doctor={{ request.GET.doctor }}{% endif %}{% if request.GET.service %}&service={{ request.GET.service }}{% endif %}{% if request.GET.start_date %}&start_date={{ request.GET.start_date }}{% endif %}{% if request.GET.end_date %}&end_date={{ request.GET.end_date }}{% endif %}{% if request.GET.per_page %}&per_page={{ request.GET.per_page }}{% endif %}" 
                           class="pagination-btn" style="padding: 8px 12px; border-radius: 8px; background: var(--card); border: 1px solid var(--card-border); color: var(--text); text-decoration: none; font-size: 14px;">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    {% else %}
                        <span class="pagination-btn disabled" style="padding: 8px 12px; border-radius: 8px; background: var(--bg); border: 1px solid var(--card-border); color: var(--text-secondary); font-size: 14px; cursor: not-allowed;">
                            <i class="bi bi-chevron-right"></i>
                        </span>
                        <span class="pagination-btn disabled" style="padding: 8px 12px; border-radius: 8px; background: var(--bg); border: 1px solid var(--card-border); color: var(--text-secondary); font-size: 14px; cursor: not-allowed;">
                            <i class="bi bi-chevron-double-right"></i>
                        </span>
                    {% endif %}
                </div>
            </div>
        {% endif %}
    </section>
</div>

<script>
// Tema Yönetimi
(function() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);
    const themeButtons = document.querySelectorAll('.theme-btn');
    themeButtons.forEach(btn => {
        if (btn.dataset.theme === savedTheme) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    themeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const theme = this.dataset.theme;
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            themeButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });
})();

// Mesajların otomatik kapanması
(function() {
    const messages = document.querySelectorAll('.message');
    messages.forEach(message => {
        // 5 saniye sonra otomatik kapan
        setTimeout(() => {
            message.style.opacity = '0';
            message.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                message.remove();
            }, 400);
        }, 5000);
    });
})();
</script>
</body>
</html>
